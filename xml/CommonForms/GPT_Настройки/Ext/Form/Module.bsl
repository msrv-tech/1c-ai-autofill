
&НаКлиенте
Процедура Зарегистрироваться(Команда)
	
	ОткрытьФормуРегистрации();
	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьФормуРегистрации()
	
	ОписаниеОповещения = Новый ОписаниеОповещения("ПослеЗакрытияФормыРегистрации", ЭтотОбъект);
	ОткрытьФорму("ОбщаяФорма.GPT_Регистрация", , ЭтотОбъект, , , , ОписаниеОповещения, РежимОткрытияОкнаФормы.БлокироватьОкноВладельца);
	
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗакрытияФормыРегистрации(Результат, Параметры) Экспорт
	
	// После регистрации обновляем данные формы с сервера, так как токен сохранился в базе
	ОбновитьДанныеССервера();
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьДанныеССервера()
	
	Настройки = GPT_ОбщийМодульСервер.НастройкаПоУмолчанию();
	Токен = Настройки.Токен;
	АдресСервера = Настройки.АдресСервера;
	Email = Настройки.Email;
	
КонецПроцедуры

&НаКлиенте
Процедура Сохранить(Команда)
	СохранитьСервер();
	Закрыть();
КонецПроцедуры

&НаСервере
Процедура СохранитьСервер()
	ПроверитьОбязательныеПлейсхолдерыПередЗаписью();
	Настройки = GPT_ОбщийМодульСервер.НастройкаПоУмолчанию();
    НастройкиОбъект = Настройки.ПолучитьОбъект();
	НастройкиОбъект.Токен = Токен;
	НастройкиОбъект.ПромтОписание = ПромтОписание;  
	НастройкиОбъект.АдресСервера = АдресСервера;
    НастройкиОбъект.ДополнительныеСвойстваХранилище = Новый ХранилищеЗначения(ДополнительныеСвойства.ВыгрузитьЗначения());
    НастройкиОбъект.ПромтДопСвойства = ПромтДопСвойства;
    НастройкиОбъект.МодельИИ = МодельИИ;
    НастройкиОбъект.Email = Email;
	НастройкиОбъект.Записать();
КонецПроцедуры

&НаСервере
Процедура ПроверитьОбязательныеПлейсхолдерыПередЗаписью()
	
	Ошибки = Новый Массив;
	
	// Промт для описания товара
	Если НЕ ЗначениеЗаполнено(ПромтОписание) Тогда
		Ошибки.Добавить("Промт (описание) не заполнен. Обязательный плейсхолдер: {Наименование}.");
	ИначеЕсли СтрНайти(ПромтОписание, "{Наименование}") = 0 Тогда
		Ошибки.Добавить("В промте (описание) отсутствует плейсхолдер {Наименование}.");
	КонецЕсли;
	
	// Промт для доп. свойств товара
	Если НЕ ЗначениеЗаполнено(ПромтДопСвойства) Тогда
		Ошибки.Добавить("Промт (доп. свойства) не заполнен. Обязательные плейсхолдеры: {Наименование}, {Свойства}.");
	Иначе
		Если СтрНайти(ПромтДопСвойства, "{Наименование}") = 0 Тогда
			Ошибки.Добавить("В промте (доп. свойства) отсутствует плейсхолдер {Наименование}.");
		КонецЕсли;
		Если СтрНайти(ПромтДопСвойства, "{Свойства}") = 0 Тогда
			Ошибки.Добавить("В промте (доп. свойства) отсутствует плейсхолдер {Свойства}.");
		КонецЕсли;
	КонецЕсли;
	
	Если Ошибки.Количество() > 0 Тогда
		ВызватьИсключение "Настройки не сохранены." + Символы.ПС + СтрСоединить(Ошибки, Символы.ПС);
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка) 
	
	Настройки = GPT_ОбщийМодульСервер.НастройкаПоУмолчанию();
	Токен = Настройки.Токен; 
	ПромтОписание = Настройки.ПромтОписание;
	АдресСервера = Настройки.АдресСервера;
	Email = Настройки.Email;
	МассивСвойств = Настройки.ДополнительныеСвойстваХранилище.Получить();
	Если ТипЗнч(МассивСвойств) = Тип("Массив") Тогда
		ДополнительныеСвойства.ЗагрузитьЗначения(МассивСвойств);
	КонецЕсли;
	
    ПромтДопСвойства = Настройки.ПромтДопСвойства;
	МодельИИ = Настройки.МодельИИ;
	
	Если НЕ ЗначениеЗаполнено(ПромтОписание) Тогда 
		ПромтОписание = "Создай подробное продающее описание товара ""{Наименование}"" для интернет-магазина. Описание должно быть информативным, привлекательным для покупателей и содержать ключевые характеристики.";    
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(МодельИИ) Тогда 
		МодельИИ = "auto";    
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ПромтДопСвойства) Тогда 
		ПромтДопСвойства = 	"Для товара ""{Наименование}"" определи значения следующих свойств: {Свойства}. Ответ верни строго в формате JSON, где ключи — это имена свойств, а значения — их значения. Если не знаешь значение — не включай свойство в JSON.";    
	КонецЕсли; 
		
	// В ветке для 1С:Фреш обновление расширения через GitHub отключено.
	ЕстьОбновление = Ложь;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьРасширение(Команда)
	//@skip-check undefined-variable
	ПоказатьОповещениеПользователя("Недоступно", , "В 1С:Фреш обновление выполняется через менеджер сервиса.");

КонецПроцедуры

&НаКлиенте
Процедура СкачатьРасширение(Команда)
	//@skip-check undefined-variable
	ФайловаяСистемаКлиент.ОткрытьНавигационнуюСсылку("https://github.com/msrv-tech/1c-ai-autofill/releases");
	
КонецПроцедуры

&НаКлиенте
Процедура СсылкаНажатие(Элемент)
	//@skip-check undefined-variable
	ФайловаяСистемаКлиент.ОткрытьНавигационнуюСсылку(Элементы.Ссылка.Заголовок);
КонецПроцедуры

&НаКлиенте
Процедура ДекорацияЗаполнитьОписаниеНажатие(Элемент)
	ПромтОписание = "Создай подробное продающее описание товара ""{Наименование}"" для интернет-магазина. Описание должно быть информативным, привлекательным для покупателей и содержать ключевые характеристики.";
КонецПроцедуры

&НаКлиенте
Процедура ДекорацияЗаполнитьДопСвойстваНажатие(Элемент)
	ПромтДопСвойства = "Для товара ""{Наименование}"" определи значения следующих свойств: {Свойства}. Ответ верни строго в формате JSON, где ключи — это имена свойств, а значения — их значения. Если не знаешь значение — не включай свойство в JSON.";
КонецПроцедуры

