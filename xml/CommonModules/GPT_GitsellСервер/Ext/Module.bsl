// Серверная интеграция с Gitsell

#Область Integration_Gitsell

// Начинает процесс Device Flow авторизации
Функция Gitsell_НачатьDeviceFlow(InstanceLabel = "1C Agent", UserAgent = "1C-Enterprise") Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Ошибка", "");
	Результат.Вставить("device_code", "");
	Результат.Вставить("user_code", "");
	Результат.Вставить("verification_uri_complete", "");
	Результат.Вставить("expires_in", 0);
	Результат.Вставить("interval", 5);
	
	Попытка
		// Генерируем новый UUID для каждой сессии авторизации
		InstanceId = Строка(Новый УникальныйИдентификатор);
		
		Соединение = Новый HTTPСоединение("gitsell.ru", 443, , , , , Новый ЗащищенноеСоединениеOpenSSL());
		
		Заголовки = Новый Соответствие;
		Заголовки.Вставить("Content-Type", "application/x-www-form-urlencoded");
		Заголовки.Вставить("Accept", "application/json");
		If НЕ ПустаяСтрока(UserAgent) Тогда
			Заголовки.Вставить("User-Agent", UserAgent);
		КонецЕсли;
		
		// Параметры запроса
		ПараметрыСтрока = "client_id=1c-agent" +
			"&scope=agent:read agent:write profile:read" +
			"&instance_id=" + КодироватьСтроку(InstanceId, СпособКодированияСтроки.URLВКодировкеURL) +
			"&instance_label=" + КодироватьСтроку(InstanceLabel, СпособКодированияСтроки.URLВКодировкеURL);
			
		Запрос = Новый HTTPЗапрос("/api/oauth/device_authorization", Заголовки);
		Запрос.УстановитьТелоИзСтроки(ПараметрыСтрока);
		
		Ответ = Соединение.ОтправитьДляОбработки(Запрос);
		ТекстОтвета = Ответ.ПолучитьТелоКакСтроку();
		
		Если Ответ.КодСостояния = 200 Тогда
			Попытка
				ЧтениеJSON = Новый ЧтениеJSON;
				ЧтениеJSON.УстановитьСтроку(ТекстОтвета);
				Данные = ПрочитатьJSON(ЧтениеJSON);
				ЧтениеJSON.Закрыть();
				
				Результат.Успех = Истина;
				Результат.device_code = Данные.device_code;
				Результат.user_code = Данные.user_code;
				Результат.verification_uri_complete = Данные.verification_uri_complete;
				Результат.expires_in = Данные.expires_in;
				Результат.interval = Данные.interval;
			Исключение
				Результат.Ошибка = "Ошибка парсинга ответа: " + ОписаниеОшибки();
			КонецПопытки;
		Иначе
			Результат.Ошибка = "Ошибка сервера (" + Ответ.КодСостояния + "): " + ТекстОтвета;
		КонецЕсли;
		
	Исключение
		Результат.Ошибка = "Ошибка соединения: " + ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Опрашивает статус токена
Функция Gitsell_ОпросТокена(DeviceCode) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Статус", "error");
	Результат.Вставить("Токен", "");
	Результат.Вставить("Ошибка", "");
	
	Попытка
		Соединение = Новый HTTPСоединение("gitsell.ru", 443, , , , , Новый ЗащищенноеСоединениеOpenSSL());
		
		Заголовки = Новый Соответствие;
		Заголовки.Вставить("Content-Type", "application/x-www-form-urlencoded");
		Заголовки.Вставить("Accept", "application/json");
		
		ПараметрыСтрока = "client_id=1c-agent" +
			"&grant_type=urn:ietf:params:oauth:grant-type:device_code" +
			"&device_code=" + КодироватьСтроку(DeviceCode, СпособКодированияСтроки.URLВКодировкеURL);
			
		Запрос = Новый HTTPЗапрос("/api/oauth/token", Заголовки);
		Запрос.УстановитьТелоИзСтроки(ПараметрыСтрока);
		
		Ответ = Соединение.ОтправитьДляОбработки(Запрос);
		ТекстОтвета = Ответ.ПолучитьТелоКакСтроку();
		
		// Пытаемся распарсить JSON
		Данные = Неопределено;
		Попытка
			ЧтениеJSON = Новый ЧтениеJSON;
			ЧтениеJSON.УстановитьСтроку(ТекстОтвета);
			Данные = ПрочитатьJSON(ЧтениеJSON);
			ЧтениеJSON.Закрыть();
		Исключение
			// Ошибка парсинга - оставляем Данные = Неопределено
		КонецПопытки;
		
		Если Ответ.КодСостояния = 200 Тогда
			Если Данные <> Неопределено И Данные.Свойство("ai_proxy_token") Тогда
				Результат.Статус = "success";
				Результат.Токен = Данные.ai_proxy_token;
				
				// Получаем email, если access_token есть в ответе
				Если Данные.Свойство("access_token") Тогда
					Попытка
						СоединениеAPI = Новый HTTPСоединение("gitsell.ru", 443, , , , , Новый ЗащищенноеСоединениеOpenSSL());
						ЗаголовкиAPI = Новый Соответствие;
						ЗаголовкиAPI.Вставить("Authorization", "Bearer " + Данные.access_token);
						ЗапросAPI = Новый HTTPЗапрос("/api/me", ЗаголовкиAPI);
						ОтветAPI = СоединениеAPI.Получить(ЗапросAPI);
						
						Если ОтветAPI.КодСостояния = 200 Тогда
							ЧтениеJSON_API = Новый ЧтениеJSON;
							ЧтениеJSON_API.УстановитьСтроку(ОтветAPI.ПолучитьТелоКакСтроку());
							ДанныеAPI = ПрочитатьJSON(ЧтениеJSON_API);
							ЧтениеJSON_API.Закрыть();
							
							Если ДанныеAPI.Свойство("email") Тогда
								Результат.Вставить("Email", ДанныеAPI.email);
							КонецЕсли;
						КонецЕсли;
					Исключение
						// Игнорируем ошибки получения email
					КонецПопытки;
				КонецЕсли;
				
			Иначе
				Результат.Ошибка = "В ответе нет ai_proxy_token" + ?(Данные = Неопределено, " (JSON не распознан)", "");
			КонецЕсли;
		Иначе
			// Обработка ошибок OAuth
			Если Данные <> Неопределено И Данные.Свойство("error") Тогда
				КодОшибки = Данные.error;
				Если КодОшибки = "authorization_pending" Тогда
					Результат.Статус = "pending";
				ИначеЕсли КодОшибки = "slow_down" Тогда
					Результат.Статус = "slow_down";
				ИначеЕсли КодОшибки = "expired_token" Тогда
					Результат.Статус = "expired";
				ИначеЕсли КодОшибки = "access_denied" Тогда
					Результат.Статус = "denied";
				Иначе
					Результат.Статус = "error";
					Результат.Ошибка = "Ошибка OAuth: " + КодОшибки;
				КонецЕсли;
			Иначе
				Результат.Ошибка = "Ошибка сервера (" + Ответ.КодСостояния + "): " + ТекстОтвета;
			КонецЕсли;
		КонецЕсли;
		
	Исключение
		Результат.Ошибка = "Ошибка соединения: " + ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Сохраняет токен Gitsell в настройки
Процедура Gitsell_СохранитьAiProxyToken(Токен, Email = "") Экспорт
	
	НастройкиСсылка = GPT_ОбщийМодульСервер.НастройкаПоУмолчанию();
	НастройкиОбъект = НастройкиСсылка.ПолучитьОбъект();
	
	// сохраняем токен в единственный реквизит "Токен"
	НастройкиОбъект.Токен = Токен;
	
	// заполняем адрес сервера при регистрации (если пользователь еще не задавал)
	Если НЕ ЗначениеЗаполнено(НастройкиОбъект.АдресСервера) Тогда
		НастройкиОбъект.АдресСервера = "https://gitsell.ru/api";
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Email) Тогда
		НастройкиОбъект.Email = Email;
	КонецЕсли;
	
	НастройкиОбъект.Записать();
	
КонецПроцедуры

// Проверяет работу токена (GET /models)
Функция Gitsell_ПроверитьModels() Экспорт
	
	Результат = Новый Структура("Успех, Ошибка", Ложь, "");
	
	Попытка
		Настройки = GPT_ОбщийМодульСервер.НастройкаПоУмолчанию();
		Токен = Настройки.Токен;
		
		Если ПустаяСтрока(Токен) Тогда
			Результат.Ошибка = "Токен не найден в настройках";
			Возврат Результат;
		КонецЕсли;
		
		Соединение = Новый HTTPСоединение("gitsell.ru", 443, , , , , Новый ЗащищенноеСоединениеOpenSSL());
		
		Заголовки = Новый Соответствие;
		Заголовки.Вставить("Authorization", "Bearer " + Токен);
		Заголовки.Вставить("X-Gitsell-Repo", "msrv-tech/1c-ai-autofill");
		
		Запрос = Новый HTTPЗапрос("/api/v1/models", Заголовки);
		Ответ = Соединение.Получить(Запрос);
		
		Если Ответ.КодСостояния = 200 Тогда
			Результат.Успех = Истина;
		Иначе
			Результат.Ошибка = "Ошибка проверки токена (" + Ответ.КодСостояния + "): " + Ответ.ПолучитьТелоКакСтроку();
		КонецЕсли;
		
	Исключение
		Результат.Ошибка = "Ошибка соединения: " + ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти
